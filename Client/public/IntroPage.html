<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cognitive - Assesment</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="//cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/alertify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/css/alertify.min.css"
    />
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/css/themes/default.min.css"
    />
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/css/themes/semantic.min.css"
    />
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/css/themes/bootstrap.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <link href="./Task1.css" rel="stylesheet" />
  </head>

  <body>
    <div class="box">
      <br />
      <center>
        <a class="self">Candidate Assesment</a>
        <div class="intro"></div>
      </center>
      <br /><br /><br />
      <div class="container">
        <div class="steps">
          <span class="circle active">1</span>
          <span class="circle">2</span>
          <span class="circle">3</span>
          <!-- <span class="circle">4</span> -->
          <div class="progress-bar">
            <span class="indicator"></span>
          </div>
        </div>
      </div>
    </div>

    <br /><br /><br />

    <center>
      <div class="asses1" id="asses1">
        <div class="intro_text">
          <a
            >Can you give us a brief introduction about yourself in the next 2
            minutes? Feel free to cover your personal background, education,
            work experience, or anything you feel is relevant.</a
          >
        </div>

        <br /><br />
        <button class="record" id="start" onclick="start();">
          Start Assesment</button
        ><br /><br />
      </div>

      <div id="recordings" class="recordings">
        <center>
          <a class="self">Self-Introduction</a><br />
          <br />
          <div class="intro_text">
            <a
              >Can you give us a brief introduction about yourself in the next 2
              minutes? Feel free to cover your personal background, education,
              work experience, or anything you feel is relevant.</a
            >
          </div>
        </center>
        <br /><br />
        <video id="video" class="video" autoplay muted></video><br /><br />
        <!-- <div id="emotion">Emotion: Loading...</div><br> -->
        <div timer id="timer" class="timer"></div>
        <br />
        <button class="record_start" id="start_record" onclick="startRecord();">
          Start Test</button
        >&nbsp;&nbsp;&nbsp;
        <!-- <button class="record_stop" id="stop" onclick="stop();">Stop Test</button>-->

        <br /><br />
      </div>
    </center>
    <br /><br />
    <div class="end" id="end"></div>

    <!-- </div> -->
    <!-- <div class="bg-dark text-white">
        <p class="text-center p-4 m-0">Footer Content</p>
      </div> -->
  </body>
  <script>
    var sessionId;
    var userId;
    var userName;
    var email;
    var i = 0;

    const emotionElement = document.getElementById("emotion");
    var assesment_initiated = false;
    var assesment_initiated_failed = false;
    var finalText = "";
    const recognition = new webkitSpeechRecognition();
    const positiveWords = [
      "happy",
      "love",
      "good",
      "great",
      "fantastic",
      "amazing",
      "enjoy",
    ];
    const negativeWords = [
      "sad",
      "hate",
      "bad",
      "terrible",
      "awful",
      "horrible",
    ];
    let startTime;
    let wordCount = 0;
    let values = [];
    let emotionAverages = [];
    let secondEmotionBuffer = [];
    let emotionInterval;
    const recordedChunks = [];
    let mediaRecorder;
    let videoStream;
    let audioChunks = [];
    let videoChunks = [];
    let audioRecorder;
    let videoRecorder;
    let audioStream;
    var audioBlob;
    var videoBlob;
    var face = 0;
    var avg;
    var finalsentimat;
    let timerInterval;

    // window.onload = function () {
    const videoElement = document.getElementById("video");

    const camera = new Camera(videoElement, {
      onFrame: async () => {
        await faceMesh.send({ image: videoElement });
      },
      width: 680,
      height: 380,
    });

    const faceMesh = new FaceMesh({
      locateFile: (file) =>
        `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
    });

    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7,
    });

    function ratio(p1, p2, p3, p4) {
      const dist1 = Math.hypot(p2.x - p1.x, p2.y - p1.y);
      const dist2 = Math.hypot(p4.x - p3.x, p4.y - p3.y);
      return dist1 / dist2;
    }

    let emotionHistory = [];



    function startEmotionAveraging() {
      emotionInterval = setInterval(() => {
        if (secondEmotionBuffer.length > 0) {
          const emotionFrequency = secondEmotionBuffer.reduce(
            (acc, emotion) => {
              acc[emotion] = (acc[emotion] || 0) + 1;
              return acc;
            },
            {}
          );
          const avgEmotion = Object.keys(emotionFrequency).reduce((a, b) =>
            emotionFrequency[a] > emotionFrequency[b] ? a : b
          );
          if (assesment_initiated == true) {
            emotionAverages.push(avgEmotion);
            // console.log(`Averaged Emotion: ${avgEmotion}`);
            secondEmotionBuffer = [];
          }
        }
      }, 1000);
    }

    function stopEmotionAveraging() {
      clearInterval(emotionInterval);
      // console.log("Final Emotions Array:", emotionAverages);
    }

    faceMesh.onResults((results) => {
      // canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      // canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

      if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
        const landmarks = results.multiFaceLandmarks[0];

        // Calculate key ratios
        const eyeOpenness = ratio(
          landmarks[159],
          landmarks[145],
          landmarks[386],
          landmarks[374]
        ); // Eye openness ratio
        const browRaise = ratio(
          landmarks[70],
          landmarks[159],
          landmarks[300],
          landmarks[386]
        ); // Brow raise ratio
        const mouthOpenness = ratio(
          landmarks[13],
          landmarks[14],
          landmarks[61],
          landmarks[291]
        ); // Mouth openness ratio

        // console.log(`Eye: ${eyeOpenness}, Brow: ${browRaise}, Mouth: ${mouthOpenness}`);

        let detectedEmotion = "Neutral";

        // Adjusted conditions for better detection
        if (mouthOpenness > 0.65 && eyeOpenness > 0.35 && browRaise > 0.5) {
          detectedEmotion = "Yawning";
        } else if (
          browRaise > 1.2 &&
          mouthOpenness < 0.05 &&
          eyeOpenness > 1.05
        ) {
          detectedEmotion = "Angry"; // Low brow raise, clenched mouth, eyes slightly open
          // } else if (eyeOpenness < 0.15 && browRaise < 0.35) {
          //     detectedEmotion = "Sad"; // Small eye and brow movement
        } else if (mouthOpenness > 0.1 && browRaise < 1.2) {
          detectedEmotion = "Happy"; // Big smile and raised brows
          // } else if (mouthOpenness < 0.2 && browRaise < 0.3) {
          //     detectedEmotion = "Disgust"; // Limited mouth and brow movement
        } else if (browRaise > 0.8 && eyeOpenness < 0.9) {
          detectedEmotion = "Fear"; // High brows with squinting eyes
        }

        // Store recent emotions to smooth detection
        emotionHistory.push(detectedEmotion);
        if (emotionHistory.length > 10) emotionHistory.shift();

        const mostFrequentEmotion = emotionHistory.reduce((acc, curr) => {
          acc[curr] = (acc[curr] || 0) + 1;
          return acc;
        }, {});

        const dominantEmotion = Object.keys(mostFrequentEmotion).reduce(
          (a, b) => (mostFrequentEmotion[a] > mostFrequentEmotion[b] ? a : b)
        );

        // emotionElement.textContent = `Emotion: ${dominantEmotion}`;

        //  console.log(dominantEmotion);

        // Draw facial landmarks
        landmarks.forEach((landmark) => {
          // canvasCtx.beginPath();
          // canvasCtx.arc(landmark.x * canvasElement.width, landmark.y * canvasElement.height, 2, 0, 2 * Math.PI);
          // canvasCtx.fillStyle = 'red';
          // canvasCtx.fill();
        });

        secondEmotionBuffer.push(dominantEmotion);
      } else {
        if (
          assesment_initiated == true &&
          assesment_initiated_failed == false
        ) {
          assesment_initiated_failed = true;
          assesment_initiated = false;
          camera.stop();

          Swal.fire({
            allowOutsideClick: false,
            title: "Alert",
            text: "Face Not Detected",
            icon: "error",
          }).then(function () {
            stopRecord();
          });
        }
      }
    });

    function stop() {
      Swal.fire({
        icon: "info",
        title: "Are you sure, Want to stop recording?",
        showCancelButton: true,
        confirmButtonText: "Proceed",
        denyButtonText: `Don't save`,
      }).then((result) => {
        /* Read more about isConfirmed, isDenied below */
        if (result.isConfirmed) {
          camera.stop();
          stopRecord();
        }
      });
    }

    function categorizeWPM(wpm) {
      if (wpm < 100) {
        return "Bad (Too Slow)";
      } else if (wpm >= 100 && wpm < 150) {
        return "Normal";
      } else if (wpm >= 150 && wpm < 200) {
        return "Good (Medium/Fast)";
      } else {
        return "Very Fast";
      }
    }

    async function formSubmit() {
      if (event) event.preventDefault();
      if (!audioBlob || !videoBlob) {
        console.log("Blob data is not ready yet.");
        return;
      }

      console.log("Updated");
      const formData = new FormData();

      // Append to FormData
      formData.append("username", userName || "");
      formData.append("emotionData", JSON.stringify(emotionAverages || {}));
      formData.append("textData", finalText || "");
      formData.append(
        "videoFile",
        videoBlob instanceof Blob ? videoBlob : null,
        "recording.mp4"
      );
      formData.append(
        "audioFile",
        audioBlob instanceof Blob ? audioBlob : null,
        "recording.webm"
      );
      formData.append("wpm", avg || 0);
      formData.append("userId", email || "");
      formData.append("sentiment_data", finalsentimat || "");
      formData.append("sessionId", parseInt(sessionId) || 0);

      if (face === 1) {
        console.log("Submitting form data...");

        try {
          const response = await fetch("http://localhost:8000/upload", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();
          console.log("Response data:", data);
        } catch (error) {
          console.error("Error during upload:", error);
        }
        alert("Data updated succesfully");
      } else {
        redirect();
      }
    }

    function stopRecord() {
      if (assesment_initiated == false) {
        audioRecorder.stop();
        mediaRecorder.stop();

        // console.log(finalText);
        analyzeSentiment(finalText);
        finalsentimat = analyzeSentiment(finalText);

        avg = values.reduce((a, b) => a + b, 0) / values.length;
        // console.log(categorizeWPM(avg));

        // console.log(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>..Work1");
        stopEmotionAveraging();
        // console.log(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>..Work2");
        videoStream.getTracks().forEach((track) => track.stop());
        // console.log(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>..Work3");
        // console.log("ENtering");

        audioRecorder.onstop = async (event) => {
          // console.log("Audio closed");
          audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          // console.log(audioBlob instanceof Blob);
          // console.log('Audio Blob:', audioBlob);
        };

        // Handle video recording stop
        mediaRecorder.onstop = async (event) => {
          // console.log("Video closed");
          videoBlob = new Blob(recordedChunks, { type: "video/mp4" });
        };

        Swal.fire({
          title: "Submitting Please Wait!",
          html: "You will be redirected in <b></b> milliseconds.",
          timer: 3000,
          timerProgressBar: true,
          didOpen: () => {
            Swal.showLoading();
            const timer = Swal.getPopup().querySelector("b");
            timerInterval = setInterval(() => {
              timer.textContent = `${Swal.getTimerLeft()}`;
            }, 100);
          },
          willClose: () => {
            clearInterval(timerInterval);
          },
        }).then((result) => {});

        setInterval(function () {
          formSubmit();
        }, 3000);

        setInterval(function () {
          window.location.href = `./task4.html?session=${sessionId}`;
        }, 3100);
      }
    }

    // async function sendRecord(trans) {

    // }

    function redirect() {
      Swal.fire({
        allowOutsideClick: false,
        title: "Alert",
        text: "Something went wrong",
        icon: "info",
      }).then(function () {
        window.location.href = `./main.html`;
      });
    }

    async function initializeMediaRecorder() {
      console.log("recorded started");
      videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
      videoElement.srcObject = videoStream;
      mediaRecorder = new MediaRecorder(videoStream, {
        mimeType: "video/webm",
      });
      mediaRecorder.ondataavailable = (event) =>
        recordedChunks.push(event.data);

      audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioRecorder = new MediaRecorder(audioStream, {
        mimeType: "audio/webm",
      });
      audioRecorder.ondataavailable = (event) => audioChunks.push(event.data);
      mediaRecorder.start();
      audioRecorder.start();
    }

    function startRecord() {
      let timestamp = Date.now();
      document.getElementById("start_record").disabled = true;
      countdown(0, 10);
      assesment_initiated = true;
      startEmotionAveraging();
      initializeMediaRecorder();

      if ("webkitSpeechRecognition" in window) {
        recognition.lang = "en-IN";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.continuous = true; // Enable continuous listening

        recognition.onstart = function () {
          console.log("Voice recognition started. Speak into the microphone.");
        };

        recognition.onresult = function (event) {
          const transcript = event.results[event.resultIndex][0].transcript;
          finalText = finalText + transcript;
          console.log(`Transcribed text: ${transcript}`);
          // document.getElementById('messageInput').value = transcript;
          // addMessageToChat(transcript, 'user');
          // sendMessageToServer(transcript);

          const transcript1 =
            event.results[event.results.length - 1][0].transcript.trim();
          // Count words in the transcript
          wordCount += transcript1.split(/\s+/).length;
        };

        recognition.onerror = function (event) {
          console.error("Speech recognition error: ", event.error);
          // addMessageToChat('Error recognizing speech.', 'response');
        };

        recognition.onend = function () {
          console.log("Speech recognition service disconnected");

          const endTime = new Date(); // End time
          const timeDiff = (endTime - startTime) / 1000 / 60; // Convert ms to minutes

          // Calculate Words Per Minute (WPM)
          const wpm = Math.round(wordCount / timeDiff);

          // console.log(wpm);
          values.push(wpm);

          if (assesment_initiated == true) {
            wordCount = 0;
            startTime = new Date(); // Start the timer
            recognition.start(); // Restart recognition when it ends
          }
        };

        if (assesment_initiated == true) {
          wordCount = 0;
          startTime = new Date(); // Start the timer
          recognition.start(); // Restart recognition when it ends
        }
      } else {
        alert(
          "Speech Recognition is not supported in this browser. Try using Chrome."
        );
      }
    }

    function start() {
      navigator.permissions.query({ name: "camera" }).then((res) => {
        if (res.state == "granted") {
          navigator.permissions.query({ name: "microphone" }).then((res) => {
            if (res.state == "granted") {
              data_alert();
            } else {
              Swal.fire({
                allowOutsideClick: false,
                title: "Alert",
                text: "Enable microphone permission",
                icon: "error",
              });
            }
          });

          // has permission
        } else {
          Swal.fire({
            allowOutsideClick: false,
            title: "Alert",
            text: "Enable camera permission",
            icon: "error",
          });
        }
      });
    }

    function analyzeSentiment(val) {
      let score = 0;

      // Tokenize and analyze each word
      const words = val.split(/\s+/);
      words.forEach((word) => {
        if (positiveWords.includes(word)) score++;
        else if (negativeWords.includes(word)) score--;
      });

      // Determine overall sentiment
      const result =
        score > 0 ? "Positive" : score < 0 ? "Negative" : "Neutral";
      console.log(result);
      return result;
    }

    function data_alert() {
      alertify.confirm(
        "USER CONSENT",
        "<br>Hi " +
          userName +
          ",<br><br> We’d like to record this session for quality improvement purposes. The audio and video recordings will help us enhance our service and support. We assure you that your privacy is important, and all recordings will be stored securely. Do you consent to us recording during this session? If you have any concerns or prefer not to be recorded, please feel free to let us know!<br><br>",
        function () {
          // alertify.success('Ok')
          document.getElementById("recordings").style.display = "block";
          document.getElementById("start").style.display = "none";
          document.getElementById("asses1").style.display = "none";
          camera.start();
          const section = document.getElementById("end");

          if (section) {
            const sectionTop = section.offsetTop;
            window.scrollTo({
              top: sectionTop,
              behavior: "smooth",
            });
          }
        },
        function () {}
      );
    }

    var timeoutHandle;
    function countdown(minutes, seconds) {
      function tick() {
        var counter = document.getElementById("timer");
        counter.innerHTML =
          "Time Remaining: " +
          minutes.toString() +
          ":" +
          (seconds < 10 ? "0" : "") +
          String(seconds);

        if (assesment_initiated == true) {
          seconds--;
        }

        if (minutes == 0 && seconds == 0) {
          recognition.stop();
          assesment_initiated = false;
          camera.stop();
          if (i == 0) {
            Swal.fire({
              allowOutsideClick: false,
              title: "Alert",
              text: "Timeout! Kindly move to next session",
              icon: "info",
            }).then(function () {
              face = 1;
              stopRecord();
            });
            i = i + 1;
          }
        }
        if (seconds >= 0) {
          timeoutHandle = setTimeout(tick, 1000);
        } else {
          if (minutes >= 1) {
            // countdown(mins-1);   never reach “00″ issue solved:Contributed by Victor Streithorst
            setTimeout(function () {
              countdown(minutes - 1, 59);
            }, 1000);
          }
        }
      }
      tick();
    }
  </script>
</html>
